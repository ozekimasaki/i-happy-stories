# ものがたりWeavers：技術的実装フロー

このドキュメントは、Webアプリケーション「ものがたりWeavers」をゼロから構築するための、技術的な実装手順をステップバイステップで定義します。

---

### **Step 1: プロジェクト基盤のセットアップ**

1.  **Honoプロジェクト作成**:
    -   `npm create hono@latest` を実行し、対話形式で `cloudflare-workers` テンプレートを選択してプロジェクトを初期化します。
    
2.  **Vite統合**:
    -   `@hono/vite-dev-server` を導入し、単一の `npm run dev` コマンドでバックエンド（Hono）とフロントエンド（React）が同時に起動する開発環境を構築します。

3.  **環境変数管理**:
    -   `.dev.vars` ファイルを作成し、後続ステップで使用するSupabaseとGoogle Gemini APIのキーを管理する準備をします。
    -   本番環境では `wrangler` の Secret 機能に登録します。

---

### **Step 2: バックエンドAPIの基礎構築 (Hono)**

1.  **基本ルーティング**:
    -   HonoでAPIのベースとなるルーター (`/api/*`) を作成します。
    -   API以外のパスへのリクエストは、ViteでビルドされたReactアプリ (SPA) を返すように、静的ファイル配信のルートを設定します。

2.  **Supabase連携 (認証)**:
    -   Supabaseクライアントを導入し、ユーザー認証（サインアップ、ログイン）機能を実装します。
    -   APIルートに認証ミドルウェアを導入し、保護されたエンドポイントを作成します。

---

### **Step 3: フロントエンドUIの基礎構築 (React)**

1.  **コンポーネント作成**:
    -   ユーザーが「出来事」を入力するためのフォームコンポーネントを作成します。
    -   生成された「物語」と「イラスト」を表示するためのビューコンポーネントを作成します。

2.  **認証フロー実装**:
    -   Supabaseのクライアントライブラリを使い、ログイン・サインアップページと、認証状態を管理するロジックを実装します。

---

### **Step 4: コア機能の実装 (物語生成)**

1.  **物語生成APIエンドポイント作成**:
    -   バックエンドに、物語を生成するためのAPIエンドポイント (例: `POST /api/stories`) を作成します。

2.  **Gemini API連携 (Text)**:
    -   このエンドポイント内で、`@google/genai` パッケージを使用し、フロントエンドから受け取ったテキストと `ai_prompt_instruction.md` に基づくプロンプトを組み立て、Gemini APIにリクエストを送信するロジックを実装します。

3.  **データ永続化**:
    -   生成された物語のテキストを、ユーザー情報と紐付けてSupabaseデータベースに保存します。

4.  **フロントエンド連携**:
    -   入力フォームからこのAPIを呼び出し、返却された物語をビューコンポーネントに表示させます。

---

### **Step 5: コア機能の実装 (イラスト生成)**

1.  **イラスト生成ロジック追加**:
    -   物語生成後、そのテキストを基にイラスト生成用のプロンプトを組み立て、再度Gemini APIにリクエストを送信する処理をバックエンドに追加します。

2.  **【最重要R&D】キャラクター一貫性の技術検証**:
    -   `development_spec.md` の要件に基づき、Gemini APIのマルチモーダル機能（参照画像の添付など）を活用して、ページ間でキャラクターの一貫性を保つための技術検証と実装を優先的に行います。

3.  **データ永続化とフロントエンド連携**:
    -   生成されたイラストのURL等をSupabaseに保存し、フロントエンドのビューコンポーネントに表示させます。

---

### **Step 6: デプロイとCI/CD**

1.  **Cloudflare Pages/Workers 設定**:
    -   `wrangler.toml` を設定し、`npm run deploy` でアプリケーションがCloudflareにデプロイできる状態を整えます。

2.  **自動デプロイ設定**:
    -   GitHubリポジトリとCloudflareを連携させ、`main` ブランチへのプッシュをトリガーに、テストとデプロイが自動で実行されるCI/CDパイプラインを構築します。 